<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>YouTube Search & Summarize Tool</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <!-- Content-Security-Policy: 意図しないリソースの読み込みを制限 -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' https://cdnjs.cloudflare.com https://unpkg.com 'unsafe-inline';
    style-src 'self' 'unsafe-inline';
    img-src 'self' https://i.ytimg.com https://placehold.co;
    connect-src https://www.googleapis.com https://generativelanguage.googleapis.com;
    frame-ancestors 'none';
    form-action 'self';
    base-uri 'self';
  ">

  <!-- 外部ライブラリをバージョン固定で安全に読み込み -->
  <!-- DOMPurify (HTML Sanitizer) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.11/purify.min.js" xintegrity="sha512-S/PLyQJzMcCXNfEw2hbcmQAfl9p3f52+gTeJVLzU9C8V2fNrgCEa+L0e3fQhM8G4LIZg3u2Kj2uaeKjSo33u0w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <!-- showdown (Markdown Parser) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js" xintegrity="sha512-LhccdVNGe2gnAyhACORcLSjPvdCoXCXlGMzVR91ADucSS/b/wXpEBC9CRTZFabKaa_R2UeA8TMVdGjtYaC/3gA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <!-- lucide-icons -->
  <script src="https://unpkg.com/lucide@0.400.0" xintegrity="sha384-NlqZ2tGmc1P08c/xT8zblQ2O4fCRoDAm2iOCW/Bfl9v0z5/yr4zEN/2gU01TAm5q" crossorigin="anonymous"></script>

  <style>
    body { font-family: system-ui, sans-serif; margin: 0; background-color: #f9fafb; color: #111827; display: flex; flex-direction: column; min-height: 100vh; }
    main { flex: 1; padding: 24px; max-width: 1200px; margin: 0 auto; width: 100%; box-sizing: border-box;}
    h1 { color: #d32f2f; }
    
    .api-key-section {
        background-color: #fffde7;
        border: 1px solid #fbc02d;
        padding: 16px;
        border-radius: 8px;
        margin-bottom: 24px;
    }
    .api-key-section h2 {
        margin-top: 0;
        font-size: 1.1rem;
        color: #c08a00;
    }
    .api-key-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
    }
    .api-key-input-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    .api-key-input-group label {
        font-weight: 600;
        font-size: 0.9rem;
    }
    .api-key-input-group input {
        width: 100%;
        box-sizing: border-box;
    }
    .api-controls {
        margin-top: 12px;
        display: flex;
        gap: 12px;
        align-items: center;
    }
    .api-status {
        font-size: 0.9rem;
        font-weight: 500;
    }
    .api-status.ok { color: #2e7d32; }
    .api-status.error { color: #d32f2f; }
    .api-key-notes {
        margin-top: 16px;
        font-size: 0.85rem;
        color: #555;
        line-height: 1.6;
    }

    form, .controls { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; margin-bottom: 8px; }
    input[type="text"], input[type="password"], select { 
      padding: 10px; 
      min-width: 200px; 
      border-radius: 8px; 
      border: 1px solid #ccc;
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    input[type="text"]:focus, input[type="password"]:focus, select:focus {
      border-color: #d32f2f;
      box-shadow: 0 0 5px rgba(211, 47, 47, 0.5);
      outline: none;
    }
    button { 
      padding: 10px 16px; 
      cursor: pointer; 
      border: none; 
      background-color: #d32f2f; 
      color: white; 
      border-radius: 8px;
      font-weight: 600;
      transition: background-color 0.3s;
    }
    button:hover { background-color: #b71c1c; }
    button:disabled { background-color: #aaa; cursor: not-allowed; }
    
    #presets {
        display: flex;
        flex-direction: column;
        gap: 16px;
        margin-bottom: 24px;
    }
    .preset-group {
        position: relative;
    }
    .preset-group span {
        font-weight: 600;
        color: #555;
        font-size: 0.95rem;
        display: block;
        margin-bottom: 8px;
    }
    .presets-buttons {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: center;
    }
    .preset-btn {
        padding: 8px 14px;
        cursor: pointer;
        border: 1px solid #ccc;
        background-color: #f0f0f0;
        color: #333;
        border-radius: 16px;
        font-size: 0.9rem;
        font-weight: 500;
        transition: background-color 0.3s, border-color 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }
    .preset-btn:hover {
        background-color: #e0e0e0;
        border-color: #bbb;
    }
    .delete-preset-btn {
        background: none;
        border: none;
        color: #aaa;
        cursor: pointer;
        padding: 0;
        margin-left: -4px;
    }
    .delete-preset-btn:hover {
        color: #d32f2f;
    }
    .clear-history-btn {
        position: absolute;
        top: 0;
        right: 0;
        font-size: 0.8rem;
        color: #888;
        background: none;
        border: none;
        cursor: pointer;
        padding: 4px;
    }
    .clear-history-btn:hover {
        color: #d32f2f;
    }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-top: 16px; }
    .card { 
      background-color: white;
      border: 1px solid #ddd; 
      border-radius: 12px; 
      overflow: hidden; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: transform 0.2s, box-shadow 0.2s;
      display: flex;
      flex-direction: column;
    }
    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .thumb { width: 100%; display: block; aspect-ratio: 16 / 9; object-fit: cover; }
    .meta { padding: 12px 14px; flex-grow: 1; display: flex; flex-direction: column; }
    .title { font-weight: 600; margin: 0 0 8px; line-height: 1.4; font-size: 1rem; }
    .title a { text-decoration: none; color: inherit; }
    .title a:hover { color: #d32f2f; }
    .sub { color: #555; font-size: 0.9rem; margin: 4px 0; }
    .small { color: #777; font-size: 0.85rem; }
    .options { 
        margin: 12px 0 16px; 
        display: flex;
        gap: 24px;
        flex-wrap: wrap;
    }
    .options label { 
        display: inline-flex; 
        align-items: center; 
        gap: 8px; 
        font-size: 0.9rem; 
        color: #555; 
        cursor: pointer;
    }
    .summary-controls { 
        margin-top: auto; 
        padding-top: 10px;
        display: flex;
        gap: 8px;
    }
    .summary-style-select {
        flex-grow: 1;
        padding: 8px;
        border-radius: 6px;
        border: 1px solid #ccc;
        background-color: #fff;
        font-size: 0.85rem;
    }
    .summarize-btn {
      background-color: #4285F4;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: background-color 0.3s;
      white-space: nowrap;
    }
    .summarize-btn:hover { background-color: #3367D6; }
    .summary-content {
      margin-top: 8px;
      padding-top: 4px;
      border-top: 1px solid #eee;
      white-space: pre-wrap;
      line-height: 1.4;
      color: #333;
      font-size: 0.9rem;
    }
    .summary-content strong {
        color: #d32f2f;
        font-weight: 600;
    }
     .summary-content h4 {
        font-size: 1rem;
        font-weight: 600;
        margin-top: 0.5rem;
        margin-bottom: 0.5rem;
    }
    .summary-content ul {
        list-style: none;
        padding-left: 0;
    }
    .summary-content li {
        display: flex;
        align-items: flex-start;
        margin-bottom: 0.5rem;
        line-height: 1.6;
    }
    .summary-content li svg {
        width: 18px;
        height: 18px;
        margin-right: 0.5rem;
        flex-shrink: 0;
        margin-top: 4px;
        color: #4285F4;
    }
    .summary-content li span {
        flex: 1;
        min-width: 0;
    }
    .loader-container { text-align: center; padding: 10px; }
    .loader {
      display: inline-block;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #d32f2f;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .follow-up-container {
      margin-top: 16px;
      padding-top: 12px;
      border-top: 1px solid #eee;
    }
    .follow-up-title {
      font-weight: 600;
      font-size: 0.9rem;
      color: #444;
      margin-bottom: 8px;
    }
    .follow-up-prompt {
      width: 100%;
      box-sizing: border-box;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 0.9rem;
      min-height: 60px;
      margin-bottom: 8px;
    }
    .follow-up-btn {
      background-color: #00796b;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.85rem;
      cursor: pointer;
      width: 100%;
      transition: background-color 0.3s;
    }
    .follow-up-btn:hover { background-color: #004d40; }
    .follow-up-answer {
      margin-top: 12px;
      padding: 10px;
      background-color: #f0f4f8;
      border-radius: 6px;
      font-size: 0.9rem;
      white-space: pre-wrap;
      line-height: 1.5;
    }
    #load-more-container {
        text-align: center;
        margin-top: 24px;
    }
    .load-more-btn {
        background-color: #555;
    }
    .load-more-btn:hover {
        background-color: #333;
    }
    footer {
        background-color: #111827;
        color: #d1d5db;
        padding: 24px;
        text-align: center;
        font-size: 0.9rem;
        margin-top: 32px;
    }
    footer a {
        color: #9ca3af;
        text-decoration: underline;
    }
    footer a:hover {
        color: #f9fafb;
    }
    footer p {
        margin: 8px 0;
    }
    .footer-branding {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 8px;
        margin-bottom: 12px;
    }
    .license-info {
        font-size: 0.8rem;
        color: #9ca3af;
        margin-top: 16px;
    }
  </style>
</head>
<body>
  <main>
    <h1>YouTube 検索 & AI要約ツール</h1>

    <div class="api-key-section">
        <h2>APIキー設定</h2>
        <div class="api-key-grid">
            <div class="api-key-input-group">
                <label for="youtubeApiKey">YouTube API Key</label>
                <input type="password" id="youtubeApiKey" placeholder="YouTube APIキーを入力">
                <div id="youtubeApiStatus" class="api-status"></div>
            </div>
            <div class="api-key-input-group">
                <label for="geminiApiKey">Gemini API Key</label>
                <input type="password" id="geminiApiKey" placeholder="Gemini APIキーを入力">
                <div id="geminiApiStatus" class="api-status"></div>
            </div>
        </div>
        <div class="api-controls">
            <button id="saveApiKeysBtn" style="background-color: #1d4ed8;">保存</button>
            <button id="testApiKeysBtn" style="background-color: #555;">接続テスト</button>
        </div>
        <div class="api-key-notes">
            <p>
                <strong>注:</strong> 入力されたAPIキーは、お使いのブラウザ内にのみ保存され、外部には送信されません。
            </p>
            <p>
                <strong>セキュリティ推奨:</strong> 不正利用を防ぐため、ご自身のAPIキーにはHTTPリファラー制限を設定することを強く推奨します。
            </p>
        </div>
    </div>

    <div id="presets">
        <div class="preset-group">
          <span>マイプリセット</span>
           <p class="small" style="margin-top: -4px; margin-bottom: 8px;">※プリセットが消える場合、ブラウザの「終了時にデータを削除」等の設定をご確認ください。</p>
          <div id="custom-presets-buttons" class="presets-buttons">
            <!-- Custom presets will be dynamically added here -->
          </div>
        </div>
        <div class="preset-group">
          <span>検索履歴</span>
          <button id="clear-history-btn" class="clear-history-btn" title="履歴を削除">クリア</button>
          <div id="history-buttons" class="presets-buttons">
            <!-- History items will be dynamically added here -->
          </div>
        </div>
    </div>

    <form id="searchForm">
        <div class="controls">
          <input id="q" type="text" placeholder="キーワードで検索" value="" />
          <input id="channelId" type="text" placeholder="またはチャンネルID" />
          <select id="order">
            <option value="date" selected>新着順</option>
            <option value="viewCount">人気順</option>
            <option value="relevance">関連性</option>
            <option value="rating">評価順</option>
          </select>
          <select id="region">
            <option value="JP" selected>日本 (JP)</option>
            <option value="US">米国 (US)</option>
            <option value="GB">英国 (GB)</option>
            <option value="KR">韓国 (KR)</option>
          </select>
          <select id="safe">
            <option value="none" selected>セーフサーチ: なし</option>
            <option value="moderate">セーフサーチ: 標準</option>
            <option value="strict">セーフサーチ: 強</option>
          </select>
          <button type="submit">検索</button>
        </div>
        <div class="options">
            <label>
                <input type="checkbox" id="recentOnly" />
                直近48時間以内の動画のみ
            </label>
            <label>
                <input type="checkbox" id="excludeShorts" checked />
                ショート動画を除外する
            </label>
        </div>
    </form>
    
    <div style="margin-top: 20px; padding: 16px; background-color: #f3f4f6; border-radius: 8px;">
      <h3 style="margin-top: 0; margin-bottom: 12px; font-size: 1rem;">現在の検索条件をプリセットとして保存</h3>
      <div class="controls">
          <input id="presetName" type="text" placeholder="プリセット名を入力" />
          <button id="savePresetBtn" style="background-color: #00796b;">保存</button>
      </div>
      <p id="preset-status" class="small" style="margin-top: 8px;"></p>
    </div>

    <div id="status" class="small" style="margin-top: 16px;"></div>
    <div id="results" class="grid"></div>
    <div id="load-more-container"></div>
    
    <p class="small" style="background-color: #fffbeb; border: 1px solid #f59e0b; padding: 10px; border-radius: 8px; margin-top: 24px;">
        <strong>注意:</strong> 本ツールの利用により消費されるAPIのクォータ（利用上限）や料金は、すべてAPIキーの所有者（利用者自身）に帰属します。YouTube APIには無料の利用上限があり、短時間の連続使用で一時的に使えなくなる場合があります。Gemini APIは無料枠を超えると料金が発生する可能性があります。
    </p>
  </main>
  
  <footer>
    <div class="footer-branding">
        <span>Powered by</span>
        <a href="https://www.youtube.com" target="_blank" rel="noopener noreferrer">
            <svg enable-background="new 0 0 28.9 20.2" viewBox="0 0 28.9 20.2" xml:space="preserve" style="height: 20px; fill: #d1d5db;"><path d="M28.2 3.2c-.3-.9-1-1.7-1.9-2C24.5.3 14.5.3 14.5.3s-10 0-11.8.9c-.9.3-1.6 1-1.9 2S.3 6.3.3 10.1s0 6.9.5 7.7c.3.9 1 1.7 1.9 2 1.8.9 11.8.9 11.8.9s10 0 11.8-.9c.9-.3 1.6-1 1.9-2 .5-.8.5-4.6.5-7.7s0-6.9-.5-7.7zM11.5 14.4V5.8l8 4.3-8 4.3z"></path></svg>
        </a>
    </div>
    <p>本アプリケーションは、利用者が入力したAPIキーや検索履歴などの情報を、利用者のブラウザ内（ローカルストレージ）にのみ保存します。これらの情報が開発者や第三者に送信されることはありません。</p>
    <p>This tool complies with the <a href="https://developers.google.com/youtube/terms/api-services-terms-of-service" target="_blank">YouTube API Services Terms of Service</a>.</p>
    <div class="license-info">
      <p>This tool uses the following open-source libraries: DOMPurify (MPL-2.0), showdown (MIT), and Lucide (ISC).</p>
      <button id="clearAllDataBtn" style="background-color: transparent; border: 1px solid #9ca3af; color: #9ca3af; font-size: 0.8rem; padding: 4px 8px; margin-top: 8px;">全データ削除</button>
    </div>
  </footer>

  <script>
    const YOUTUBE_API_KEY_STORAGE = 'youtubeSearchApiKey';
    const GEMINI_API_KEY_STORAGE = 'geminiSearchApiKey';
    const PRESETS_STORAGE_KEY = 'youtubeSearchCustomPresets_v2';
    const HISTORY_STORAGE_KEY = 'youtubeSearchHistory';

    // DOM Elements
    const youtubeApiKeyInput = document.getElementById("youtubeApiKey");
    const geminiApiKeyInput = document.getElementById("geminiApiKey");
    const saveApiKeysBtn = document.getElementById("saveApiKeysBtn");
    const testApiKeysBtn = document.getElementById("testApiKeysBtn");
    const youtubeApiStatus = document.getElementById("youtubeApiStatus");
    const geminiApiStatus = document.getElementById("geminiApiStatus");
    
    const form = document.getElementById("searchForm");
    const q = document.getElementById("q");
    const order = document.getElementById("order");
    const region = document.getElementById("region");
    const safe = document.getElementById("safe");
    const recentOnly = document.getElementById("recentOnly");
    const excludeShorts = document.getElementById("excludeShorts");
    const results = document.getElementById("results");
    const statusEl = document.getElementById("status");
    const presetsContainer = document.getElementById("presets");
    const channelIdInput = document.getElementById("channelId");
    const savePresetBtn = document.getElementById('savePresetBtn');
    const presetNameInput = document.getElementById('presetName');
    const presetStatusEl = document.getElementById('preset-status');
    const customPresetsButtonsContainer = document.getElementById('custom-presets-buttons');
    const historyButtonsContainer = document.getElementById('history-buttons');
    const clearHistoryBtn = document.getElementById('clear-history-btn');
    const loadMoreContainer = document.getElementById('load-more-container');
    const clearAllDataBtn = document.getElementById('clearAllDataBtn');

    let nextPageToken = null;
    let lastSearchParams = null;
    let YOUTUBE_API_KEY = "";
    let GEMINI_API_KEY = "";

    // --- API Key Management ---
    function loadApiKeys() {
        YOUTUBE_API_KEY = localStorage.getItem(YOUTUBE_API_KEY_STORAGE) || "";
        GEMINI_API_KEY = localStorage.getItem(GEMINI_API_KEY_STORAGE) || "";
        youtubeApiKeyInput.value = YOUTUBE_API_KEY;
        geminiApiKeyInput.value = GEMINI_API_KEY;
        if (!YOUTUBE_API_KEY || !GEMINI_API_KEY) {
            statusEl.textContent = "APIキーが設定されていません。上の欄から設定してください。";
        }
    }

    function saveApiKeys() {
        YOUTUBE_API_KEY = youtubeApiKeyInput.value.trim();
        GEMINI_API_KEY = geminiApiKeyInput.value.trim();
        localStorage.setItem(YOUTUBE_API_KEY_STORAGE, YOUTUBE_API_KEY);
        localStorage.setItem(GEMINI_API_KEY_STORAGE, GEMINI_API_KEY);
        alert('APIキーを保存しました。');
        testApiKeys();
    }

    async function testApiKeys() {
        // YouTube API Test
        youtubeApiStatus.textContent = "テスト中...";
        youtubeApiStatus.className = "api-status";
        try {
            const ytKey = youtubeApiKeyInput.value.trim();
            if (!ytKey) throw new Error("キーが入力されていません");
            const res = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&q=test&key=${ytKey}`);
            if (res.status === 400) throw new Error("キーが無効です");
            if (!res.ok) throw new Error(`HTTP ${res.status} エラー`);
            youtubeApiStatus.textContent = "✓ 接続OK";
            youtubeApiStatus.classList.add("ok");
        } catch (err) {
            youtubeApiStatus.textContent = `✗ 接続エラー: ${err.message}`;
            youtubeApiStatus.classList.add("error");
        }

        // Gemini API Test
        geminiApiStatus.textContent = "テスト中...";
        geminiApiStatus.className = "api-status";
        try {
            const geminiKey = geminiApiKeyInput.value.trim();
            if (!geminiKey) throw new Error("キーが入力されていません");
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite:generateContent?key=${geminiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: "hello" }] }] })
            });
            if (res.status === 400) throw new Error("キーが無効、またはAPIが有効化されていません");
            if (!res.ok) throw new Error(`HTTP ${res.status} エラー`);
            geminiApiStatus.textContent = "✓ 接続OK";
            geminiApiStatus.classList.add("ok");
        } catch (err) {
            geminiApiStatus.textContent = `✗ 接続エラー: ${err.message}`;
            geminiApiStatus.classList.add("error");
        }
    }
    
    // --- Custom Preset Functions ---
    function initializeDefaultPresets() {
        const presets = JSON.parse(localStorage.getItem(PRESETS_STORAGE_KEY));
        if (presets === null) {
            const defaultPresets = [
                { name: "診断士", keyword: "中小企業診断士", channelId: "" }
            ];
            localStorage.setItem(PRESETS_STORAGE_KEY, JSON.stringify(defaultPresets));
        }
    }

    function loadCustomPresets() {
        const presets = JSON.parse(localStorage.getItem(PRESETS_STORAGE_KEY)) || [];
        renderCustomPresets(presets);
    }

    function renderCustomPresets(presets) {
        customPresetsButtonsContainer.innerHTML = '';
        if (presets.length === 0) {
            customPresetsButtonsContainer.textContent = '保存されたプリセットはありません。';
            return;
        }
        presets.forEach(preset => {
            const presetBtn = document.createElement('div');
            presetBtn.className = 'preset-btn';
            
            const btnText = document.createElement('span');
            btnText.textContent = preset.name;
            btnText.style.cursor = 'pointer';
            btnText.dataset.channelid = preset.channelId || '';
            btnText.dataset.keyword = preset.keyword || '';

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-preset-btn';
            deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>`;
            deleteBtn.dataset.presetName = preset.name;
            
            presetBtn.appendChild(btnText);
            presetBtn.appendChild(deleteBtn);
            customPresetsButtonsContainer.appendChild(presetBtn);
        });
    }

    function saveCustomPreset() {
        const name = presetNameInput.value.trim();
        const keyword = q.value.trim();
        const channelId = channelIdInput.value.trim();

        if (!name) {
            presetStatusEl.textContent = 'プリセット名を入力してください。';
            return;
        }
        if (!keyword && !channelId) {
            presetStatusEl.textContent = '保存するキーワードまたはチャンネルIDがありません。';
            return;
        }

        const presets = JSON.parse(localStorage.getItem(PRESETS_STORAGE_KEY)) || [];
        
        const filteredPresets = presets.filter(p => p.name !== name);
        const newPreset = { name, keyword, channelId };
        filteredPresets.push(newPreset);
        
        localStorage.setItem(PRESETS_STORAGE_KEY, JSON.stringify(filteredPresets));
        presetStatusEl.textContent = `プリセット「${name}」を保存しました。`;
        presetNameInput.value = '';
        loadCustomPresets();
    }

    function deleteCustomPreset(presetNameToDelete) {
        let presets = JSON.parse(localStorage.getItem(PRESETS_STORAGE_KEY)) || [];
        presets = presets.filter(p => p.name !== presetNameToDelete);
        localStorage.setItem(PRESETS_STORAGE_KEY, JSON.stringify(presets));
        loadCustomPresets();
        presetStatusEl.textContent = `プリセット「${presetNameToDelete}」を削除しました。`;
    }
    
    // --- History Functions ---
    function loadSearchHistory() {
        const history = JSON.parse(localStorage.getItem(HISTORY_STORAGE_KEY)) || [];
        renderSearchHistory(history);
    }
    
    function renderSearchHistory(history) {
        historyButtonsContainer.innerHTML = '';
        if (history.length === 0) {
            historyButtonsContainer.textContent = '検索履歴はありません。';
            return;
        }
        history.forEach(item => {
            const historyBtn = document.createElement('button');
            historyBtn.className = 'preset-btn';
            let displayText = item.keyword;
            if (item.channelId) {
                displayText = item.keyword ? `${item.channelId.substring(0,8)}... + ${item.keyword}` : item.channelId.substring(0,8) + '...';
            }
            historyBtn.textContent = displayText || '...';
            historyBtn.title = `キーワード: ${item.keyword}\nチャンネルID: ${item.channelId}`;
            historyBtn.dataset.keyword = item.keyword || '';
            historyBtn.dataset.channelid = item.channelId || '';
            historyButtonsContainer.appendChild(historyBtn);
        });
    }

    function saveSearchToHistory(keyword, channelId) {
        if (!keyword && !channelId) return;
        let history = JSON.parse(localStorage.getItem(HISTORY_STORAGE_KEY)) || [];
        
        history = history.filter(item => !(item.keyword === keyword && item.channelId === channelId));
        history.unshift({ keyword, channelId });
        history = history.slice(0, 10);
        localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(history));
        renderSearchHistory(history);
    }

    function clearSearchHistory() {
        if (confirm('検索履歴をすべて削除しますか？')) {
            localStorage.removeItem(HISTORY_STORAGE_KEY);
            loadSearchHistory();
        }
    }

    function clearAllData() {
        if (confirm('APIキー、プリセット、検索履歴など、このサイトに関するすべての保存データを削除しますか？\nこの操作は元に戻せません。')) {
            localStorage.removeItem(YOUTUBE_API_KEY_STORAGE);
            localStorage.removeItem(GEMINI_API_KEY_STORAGE);
            localStorage.removeItem(PRESETS_STORAGE_KEY);
            localStorage.removeItem(HISTORY_STORAGE_KEY);
            alert('すべてのデータを削除しました。ページをリロードします。');
            window.location.reload();
        }
    }

    // --- Event Listeners ---
    saveApiKeysBtn.addEventListener('click', saveApiKeys);
    testApiKeysBtn.addEventListener('click', testApiKeys);
    clearAllDataBtn.addEventListener('click', clearAllData);
    
    presetsContainer.addEventListener('click', (e) => {
        const target = e.target;
        const presetBtn = target.closest('.preset-btn');
        if (presetBtn) {
            const span = presetBtn.querySelector('span');
            const elementToGetDataFrom = span || presetBtn;

            const channelId = elementToGetDataFrom.dataset.channelid || '';
            const keyword = elementToGetDataFrom.dataset.keyword || '';
            
            channelIdInput.value = channelId;
            q.value = keyword;
            
            search();
            return;
        }
        const deleteBtn = target.closest('.delete-preset-btn');
        if (deleteBtn) {
            const presetName = deleteBtn.dataset.presetName;
            if (presetName && confirm(`プリセット「${presetName}」を削除しますか？`)) {
                deleteCustomPreset(presetName);
            }
        }
    });

    savePresetBtn.addEventListener('click', saveCustomPreset);
    clearHistoryBtn.addEventListener('click', clearSearchHistory);

    function fmtDate(iso) {
      try {
        const d = new Date(iso);
        return d.toLocaleString("ja-JP", { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
      } catch { return iso; }
    }
    
    function parseISO8601Duration(iso) {
      const regex = /PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/;
      const matches = iso.match(regex);
      if (!matches) return 0;
      const hours = parseInt(matches[1] || 0);
      const minutes = parseInt(matches[2] || 0);
      const seconds = parseInt(matches[3] || 0);
      return hours * 3600 + minutes * 60 + seconds;
    }

    /**
     * Creates a video card element from video data and appends it to the results grid.
     * This function uses safe methods (createElement, textContent, setAttribute) to prevent XSS.
     * @param {object} item - The video item object from the YouTube API.
     */
    function createSafeVideoCard(item) {
        const vid = item.id?.videoId;
        if (!vid) return;

        const sn = item.snippet || {};
        const thumbUrl = sn.thumbnails?.medium?.url || sn.thumbnails?.default?.url || `https://placehold.co/320x180/eee/ccc?text=No+Image`;
        const videoTitle = sn.title || "(no title)";
        const channelTitle = sn.channelTitle || "(unknown)";
        const publishedDate = sn.publishedAt ? fmtDate(sn.publishedAt) : "";
        const videoUrl = `https://www.youtube.com/watch?v=${encodeURIComponent(vid)}`;

        const card = document.createElement("article");
        card.className = "card";

        // Thumbnail
        const thumbLink = document.createElement("a");
        thumbLink.href = videoUrl;
        thumbLink.target = "_blank";
        thumbLink.rel = "noopener noreferrer";
        
        const thumbImg = document.createElement("img");
        thumbImg.className = "thumb";
        thumbImg.src = thumbUrl;
        thumbImg.alt = videoTitle;
        thumbImg.loading = "lazy";
        thumbImg.onerror = () => { this.src='https://placehold.co/320x180/eee/ccc?text=Image+Error' };
        
        thumbLink.appendChild(thumbImg);
        card.appendChild(thumbLink);

        // Meta container
        const meta = document.createElement("div");
        meta.className = "meta";
        
        const infoDiv = document.createElement("div");

        // Title
        const titleH3 = document.createElement("h3");
        titleH3.className = "title";
        const titleLink = document.createElement("a");
        titleLink.href = videoUrl;
        titleLink.target = "_blank";
        titleLink.rel = "noopener noreferrer";
        titleLink.title = videoTitle;
        titleLink.textContent = videoTitle;
        titleH3.appendChild(titleLink);
        infoDiv.appendChild(titleH3);

        // Channel
        const channelDiv = document.createElement("div");
        channelDiv.className = "sub";
        channelDiv.textContent = channelTitle;
        infoDiv.appendChild(channelDiv);

        // Published Date
        const publishedDiv = document.createElement("div");
        publishedDiv.className = "sub small";
        publishedDiv.textContent = `公開: ${publishedDate}`;
        infoDiv.appendChild(publishedDiv);
        
        meta.appendChild(infoDiv);

        // Summary Controls
        const summaryControls = document.createElement("div");
        summaryControls.className = "summary-controls";

        const summarySelect = document.createElement("select");
        summarySelect.className = "summary-style-select";
        summarySelect.innerHTML = `
            <option value="default" selected>要約 (標準)</option>
            <option value="points">重要なポイントを3つ抽出</option>
            <option value="brief">簡潔な概要</option>
        `;
        summaryControls.appendChild(summarySelect);

        const summarizeBtn = document.createElement("button");
        summarizeBtn.className = "summarize-btn";
        summarizeBtn.dataset.videoid = vid;
        summarizeBtn.textContent = "実行";
        summaryControls.appendChild(summarizeBtn);
        
        meta.appendChild(summaryControls);

        // Summary Content
        const summaryContent = document.createElement("div");
        summaryContent.className = "summary-content";
        meta.appendChild(summaryContent);

        // Follow-up
        const followUpContainer = document.createElement("div");
        followUpContainer.className = "follow-up-container";
        followUpContainer.style.display = "none";
        
        const followUpTitle = document.createElement("p");
        followUpTitle.className = "follow-up-title";
        followUpTitle.textContent = "追加の質問";
        followUpContainer.appendChild(followUpTitle);

        const followUpPrompt = document.createElement("textarea");
        followUpPrompt.className = "follow-up-prompt";
        followUpPrompt.placeholder = "例：動画の結論は何ですか？";
        followUpContainer.appendChild(followUpPrompt);
        
        const followUpBtn = document.createElement("button");
        followUpBtn.className = "follow-up-btn";
        followUpBtn.dataset.videoid = vid;
        followUpBtn.textContent = "この動画について質問する";
        followUpContainer.appendChild(followUpBtn);

        const followUpAnswer = document.createElement("div");
        followUpAnswer.className = "follow-up-answer";
        followUpContainer.appendChild(followUpAnswer);

        meta.appendChild(followUpContainer);
        card.appendChild(meta);
        results.appendChild(card);
    }


    async function processAndRenderItems(items) {
        let itemsToRender = items;

        if (excludeShorts.checked) {
            statusEl.textContent = "動画の詳細情報を取得し、ショート動画を除外中…";
            const videoIds = itemsToRender.map(item => item.id.videoId).filter(Boolean).join(',');

            if (videoIds) {
                const detailsParams = new URLSearchParams({
                    part: 'contentDetails,snippet',
                    id: videoIds,
                    key: YOUTUBE_API_KEY
                });
                const detailsUrl = `https://www.googleapis.com/youtube/v3/videos?${detailsParams.toString()}`;
                const detailsRes = await fetch(detailsUrl);

                if (!detailsRes.ok) {
                    throw new Error(`動画詳細の取得に失敗しました: ${detailsRes.status}`);
                }
                const detailsData = await detailsRes.json();
                
                const videoDetailsMap = new Map(detailsData.items.map(item => [item.id, item]));

                itemsToRender = itemsToRender.filter(item => {
                    const details = videoDetailsMap.get(item.id.videoId);
                    if (!details) return true; 
                    const duration = details.contentDetails?.duration;
                    if (!duration) return true; 
                    return parseISO8601Duration(duration) > 180;
                });
            }
        }
        
        if (itemsToRender.length === 0) {
          statusEl.textContent = "条件に合う動画はありませんでした（ショート動画を除外した結果かもしれません）。";
          return;
        }

        itemsToRender.forEach(createSafeVideoCard);
    }

    function renderLoadMoreButton() {
        loadMoreContainer.innerHTML = '';
        if (nextPageToken) {
            const button = document.createElement('button');
            button.textContent = 'もっと見る';
            button.className = 'load-more-btn';
            button.addEventListener('click', loadMore);
            loadMoreContainer.appendChild(button);
        }
    }
    
    function createApiError(response, defaultMessage) {
        return response.json().catch(() => ({
            error: { message: defaultMessage || `HTTP ${response.status} エラー` }
        })).then(errorData => {
            const message = errorData.error?.message || defaultMessage;
            return new Error(message);
        });
    }

    async function loadMore() {
        if (!nextPageToken || !lastSearchParams) return;

        const button = loadMoreContainer.querySelector('button');
        button.disabled = true;
        button.textContent = '読み込み中...';
        
        lastSearchParams.set('pageToken', nextPageToken);

        try {
            const url = `https://www.googleapis.com/youtube/v3/search?${lastSearchParams.toString()}`;
            const res = await fetch(url);
            if (!res.ok) {
                throw await createApiError(res, '追加の動画読み込みに失敗しました。');
            }
            const data = await res.json();
            
            nextPageToken = data.nextPageToken || null;
            await processAndRenderItems(data.items || []);
            renderLoadMoreButton();

        } catch (err) {
            statusEl.textContent = `エラー: ${err.message}`;
            button.disabled = false;
            button.textContent = '再度試す';
        }
    }
    
    async function search() {
      const searchQuery = q.value.trim();
      const channelIdQuery = channelIdInput.value.trim();
      
      if (!YOUTUBE_API_KEY) {
          statusEl.textContent = "YouTube APIキーが設定されていません。";
          return;
      }
      
      saveSearchToHistory(searchQuery, channelIdQuery);

      results.innerHTML = "";
      nextPageToken = null;
      lastSearchParams = null;
      renderLoadMoreButton();
      statusEl.textContent = "検索中…";
      
      try {
        if (!searchQuery && !channelIdQuery) {
            statusEl.textContent = "キーワードまたはチャンネルIDを入力してください。";
            return;
        }

        let finalChannelId = channelIdQuery;
        // If channelId is provided and does not start with 'UC', search for the channel ID first.
        if (channelIdQuery && !channelIdQuery.startsWith('UC')) {
            statusEl.textContent = `チャンネル名「${channelIdQuery}」からチャンネルIDを検索しています...`;
            const channelSearchParams = new URLSearchParams({
                part: 'snippet',
                q: channelIdQuery,
                type: 'channel',
                maxResults: '1',
                key: YOUTUBE_API_KEY
            });
            const channelSearchUrl = `https://www.googleapis.com/youtube/v3/search?${channelSearchParams.toString()}`;
            const channelRes = await fetch(channelSearchUrl);
            if (!channelRes.ok) {
                throw await createApiError(channelRes, 'チャンネル情報の検索に失敗しました。');
            }
            const channelData = await channelRes.json();

            if (channelData.items && channelData.items.length > 0) {
                finalChannelId = channelData.items[0].id.channelId;
                channelIdInput.value = finalChannelId; // Update input with the found ID
                statusEl.textContent = `チャンネルIDが見つかりました。動画を検索します...`;
            } else {
                throw new Error(`チャンネル「${channelIdQuery}」が見つかりませんでした。`);
            }
        }

        const params = new URLSearchParams({
            part: "snippet",
            type: "video",
            maxResults: "24",
            order: order.value,
            regionCode: region.value,
            safeSearch: safe.value,
            key: YOUTUBE_API_KEY
        });

        if (finalChannelId) params.set('channelId', finalChannelId);
        if (searchQuery) params.set('q', searchQuery);
        if (recentOnly.checked) {
            const date = new Date();
            date.setHours(date.getHours() - 48);
            params.set('publishedAfter', date.toISOString());
        }
        
        lastSearchParams = params;

        const url = `https://www.googleapis.com/youtube/v3/search?${params.toString()}`;
        const res = await fetch(url);
         if (!res.ok) {
             throw await createApiError(res, '検索に失敗しました。APIキーが正しいか確認してください。');
        }
        const data = await res.json();
        
        if (!data.items || data.items.length === 0) {
          statusEl.textContent = "該当する動画はありませんでした。条件を変えて再検索してください。";
          return;
        }

        await processAndRenderItems(data.items);

        const totalResults = results.children.length;
        statusEl.textContent = `ヒット: ${totalResults}件を表示`;
        
        nextPageToken = data.nextPageToken || null;
        renderLoadMoreButton();

      } catch (err) {
        console.error(err);
        statusEl.textContent = `エラー: ${err.message}`;
      }
    }

    function getSummaryPrompt(style) {
        switch (style) {
            case 'points':
                return 'あなたはこの動画の核心を見抜く専門家です。この動画で最も重要なポイントを**3つだけ**に絞り込み、番号付きリストで日本語で出力してください。会話的な前置きや後書きは一切含めず、3つのポイントのみを出力してください。';
            case 'brief':
                return 'あなたはこの動画の概要を簡潔にまとめる専門家です。この動画全体の内容を、**150字程度の簡潔な日本語の文章**で要約してください。会話的な前置きや後書きは一切含めず、要約文のみを出力してください。';
            case 'default':
            default:
                return `あなたはプロの動画アナリストです。指示に厳密に従ってください。この動画を分析し、日本語のマークダウン形式で出力してください。会話的な前置きや後書き（「はい、承知いたしました」など）は一切含めず、マークダウンの出力のみを行ってください。
出力形式は以下の例に厳密に従ってください。
- 動画の最も重要なポイントを**一つだけ**特定し、太字で記述します。この際、太字部分で不自然な改行が入らないように、一つの連続した文章としてください。
- 「分析結果」のような一般的な表現は使わず、具体的な内容を記述してください。

# 出力例
PIVOTマネーのこの動画では、楽天証券チーフ・ストラテジストの窪田真之さんが、**日本株の投資戦略**について解説しています。
以下がその要点です。
- 秋相場は短期的な休養局面であり、年末にかけて再上昇する可能性がある[00:00:25]。
- 2025年の日本株は4万4000円まで上昇する可能性があると予測されている[00:00:43]。
- 外国人投資家は日本株に強気であり、特に割安な高配当利回り株に注目している[00:02:32]。
- 新NISAの普及により、個人投資家の対局的な動きが活発化している[00:02:32]。
- 今後の注目セクターとして、金融、資源エネルギー、製造業が挙げられる[00:27:50]。`;
        }
    }

    async function callGeminiAPI(videoUrl, prompt) {
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite:generateContent?key=${GEMINI_API_KEY}`;
        
        const parts = [{ text: prompt }, { fileData: { mimeType: 'video/mp4', fileUri: videoUrl } }];
        const payload = { contents: [{ parts }], generationConfig: { temperature: 0.3, topP: 0.9, topK: 40 } };
        
        const response = await fetch(GEMINI_API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            throw await createApiError(response, 'Gemini APIからの応答がありません。キーが正しいか、またはAPIが有効になっているか確認してください。');
        }

        const result = await response.json();
        if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
            return result.candidates[0].content.parts[0].text;
        } else {
            console.warn("Unexpected API response structure:", result);
            if (result.candidates?.[0]?.finishReason === 'SAFETY') {
                throw new Error('セーフティ設定により応答がブロックされました。');
            }
            throw new Error('予期しない形式のレスポンスを受信しました。');
        }
    }

    results.addEventListener('click', async (e) => {
        // Summarize button handler
        if (e.target.classList.contains('summarize-btn')) {
            if (!GEMINI_API_KEY) {
                alert("Gemini APIキーが設定されていません。");
                return;
            }

            const button = e.target;
            const videoId = button.dataset.videoid;
            const card = button.closest('.card');
            const summaryContainer = card.querySelector('.summary-content');
            const styleSelect = card.querySelector('.summary-style-select');
            
            button.disabled = true;
            button.textContent = '要約中...';
            styleSelect.disabled = true;
            summaryContainer.innerHTML = '<div class="loader-container"><div class="loader"></div></div>';

            try {
                const videoUrl = `https://www.youtube.com/watch?v=${videoId}`;
                const summaryStyle = styleSelect.value;
                const summaryPrompt = getSummaryPrompt(summaryStyle);
                
                const summaryMarkdown = await callGeminiAPI(videoUrl, summaryPrompt);

                const converter = new showdown.Converter();
                const summaryHtml = converter.makeHtml(summaryMarkdown);
                // Sanitize HTML to prevent XSS
                summaryContainer.innerHTML = DOMPurify.sanitize(summaryHtml);
                
                card.querySelector('.follow-up-container').dataset.summary = summaryMarkdown;

                const listItems = summaryContainer.querySelectorAll('li');
                listItems.forEach(li => {
                    const iconElement = document.createElement('i');
                    iconElement.setAttribute('data-lucide', 'check-circle-2');
                    
                    const textWrapper = document.createElement('span');
                    while(li.firstChild) {
                        textWrapper.appendChild(li.firstChild);
                    }
                    li.prepend(iconElement);
                    li.appendChild(textWrapper);
                });
                lucide.createIcons();
                
                button.closest('.summary-controls').style.display = 'none';
                card.querySelector('.follow-up-container').style.display = 'block';

            } catch (err) {
                summaryContainer.innerHTML = `<p style="color: #d32f2f; font-size: 0.9em;">要約失敗: ${err.message}</p>`;
                console.error(err);
                button.textContent = '再度実行';
                button.disabled = false;
                styleSelect.disabled = false;
            }
        }
        
        // Follow-up question button handler
        if (e.target.classList.contains('follow-up-btn')) {
            const button = e.target;
            const videoId = button.dataset.videoid;
            const card = button.closest('.card');
            const followUpContainer = card.querySelector('.follow-up-container');
            const promptInput = followUpContainer.querySelector('.follow-up-prompt');
            const answerContainer = followUpContainer.querySelector('.follow-up-answer');
            const userPrompt = promptInput.value.trim();
            const previousSummary = followUpContainer.dataset.summary || '';

            if (!userPrompt) {
                answerContainer.textContent = '質問を入力してください。';
                return;
            }

            button.disabled = true;
            button.textContent = '回答を生成中...';
            answerContainer.innerHTML = '<div class="loader-container"><div class="loader"></div></div>';
            
            try {
                const videoUrl = `https://www.youtube.com/watch?v=${videoId}`;
                const followUpPrompt = `あなたはプロの動画アナリストです。
以下の要約は、あなたがこの動画について以前生成したものです。

---
**以前の要約:**
${previousSummary}
---

この要約と動画全体の情報を基にして、以下の追加の質問に日本語で詳しく答えてください。要約の内容を深掘りするような質問にも対応してください。
動画の内容と関係ない場合は「動画の内容からは回答できません」と返答してください。

**追加の質問:**
「${userPrompt}」`;

                const answerMarkdown = await callGeminiAPI(videoUrl, followUpPrompt);
                const converter = new showdown.Converter();
                const answerHtml = converter.makeHtml(answerMarkdown);
                // Sanitize HTML to prevent XSS
                answerContainer.innerHTML = DOMPurify.sanitize(answerHtml);

            } catch (err) {
                 answerContainer.innerHTML = `<p style="color: #d32f2f; font-size: 0.9em;">回答取得失敗: ${err.message}</p>`;
                 console.error(err);
            } finally {
                button.disabled = false;
                button.textContent = 'この動画について質問する';
            }
        }
    });

    form.addEventListener("submit", (e) => {
      e.preventDefault();
      search();
    });

    // --- Initial Load ---
    document.addEventListener('DOMContentLoaded', () => {
        loadApiKeys();
        initializeDefaultPresets();
        loadCustomPresets();
        loadSearchHistory();
        if (YOUTUBE_API_KEY && GEMINI_API_KEY) {
            statusEl.textContent = "プリセットボタンをクリックするか、検索条件を入力して検索してください。";
        }
    });

  </script>
</body>
</html>

